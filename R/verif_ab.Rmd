---
title: "Vérification des abondances"
date: Mis à jour le \today
lang: fr
fontsize: 12pt
output:
  pdf_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=4, fig.height=4, fig.path='Figs/',
                      echo=TRUE, warning=FALSE, message=FALSE)
```
```{r, loading_data, echo=FALSE}
library(ggplot2)
dat <- read.csv("data/generated/verifications.csv", row.names = 1)
```

## Description

Sur le jeu de données `manip_ble_2014`, les relevés floristiques sont donnés en
base 10 :

- 0 : 0 plante
- 1 : 1 plante
- 2 : entre 2 et 9 plantes
- 3 : entre 10 et 99 plantes
- 4 : entre 100 et 999 plantes
- 3 : entre 1000 et 9999 plantes

Ce jeu de données peut être utilisé pour vérifier si les estimations
d'abondances faites pour les autres manips sont valables.


## Pour les relevés en présence/absence (0/1) 
Pour tester cette estimation, toutes les notes supérieures à 1 sont ramenées à
1 puis l'estimation est faite de la même façon que les autres relevés :

\[
  abondance = \log\frac{n_0+n_1}{n_0}
\]

Avec:

- $n_0$ le nombre de quadras où l'espèce est à 0
- $n_1$ le nombre de quadras où l'espèce est à 1

Quand le nombre de parcelles à 0 est nul, la valeur retournée est `Inf`.


## Pour les relevés en log base 2

Pour tester cette estimation, toutes les notes supérieures à 2 sont ramenées à
2 puis l'estimation est faite comme pour les autres relevés, en utilisant une
loi de poisson "compound".


## Test des estimations

Les valeurs estimées sont ajustées en fonction des valeurs réelles.
Les 3 différentes périodes sont séparées, ce qui donne les résultats suivants
(la droite noire correspond à la droite $y=x$ et chaque point correspond à
l'estimation moyenne pour une espèce):

```{r base0, eval=TRUE, echo=FALSE, fig.height=9, fig.width=7}
dat_noinf <- dat[!(is.infinite(dat$esti)),]

f_labels <- aggregate(data.frame(r2 = dat$r2, eqn = dat$eqn),
                      list(periode = dat$periode, base = dat$base),
                      unique)
f_labels$r2 <- paste("R2=", round(f_labels$r2, 3), sep = "")

p <- ggplot(dat_noinf, aes(x = real, y = esti)) +
  geom_point(size = 2) +
  geom_abline(slope = 1, intercept = 0) +
  xlim(0, 40) +
  ylim(0, 40) +
  xlab("Real values") +
  ylab("Estimates") +
  facet_grid(periode ~ base) +
  geom_text(x = 32, y = 20, aes(label = eqn), data = f_labels,
            colour = "red", fontface = "bold") +
  geom_text(x = 32, y = 15, aes(label = r2), data = f_labels,
            colour = "red", fontface = "bold") +
  geom_smooth(method = "lm", colour = "red")
plot(p)
```
