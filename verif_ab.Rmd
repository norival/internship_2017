---
title: "Estimations des abondances"
date: Mis à jour le \today
lang: fr
fontsize: 12pt
output:
  pdf_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=4, fig.height=4, fig.path='Figs/',
                      echo=TRUE, warning=FALSE, message=FALSE)
```
```{r, loading_data, echo=FALSE}
library(ggplot2)
load("data/generated/data_verif.RData")
```

## Estimation des abondances

Estimation par une loi binomiale négative (résultant d'un mélange de
Gamma-Poisson).
On suppose que les plantes sont distribuées au sein de la parcelle selon une loi
de Poisson dont le paramètre $\lambda$ est lui-même une variable aléatoire.
On suppose que ce paramètre $\lambda$ suit une distribution Gamma.

\[
  P(X=k) = \frac{\Gamma(k+r)}{\Gamma(r)k!} p^r q^k
\]

Avec :

- $\Gamma(r)$ la valeur de la fonction gamma en $r$
- $p$, la probabilité de 'succès' de la loi et $q$ la probabilité complémentaire
  ($p = \frac{1}{\theta + 1}$)
- $r$ et $\theta$ sont les paramètres de la loi

L'espérance de cette loi est :

\[
  \lambda = r\frac{q}{p}
\]

Comme pour la loi de COM-Poisson, on cherche les paramètres $r$ et $\theta$ pour
lesquels la fonction de vraissemblance est maximale.

La figure suivante montre les valeurs observées en fonction des valeurs estimées
(en log).
L'estimation par la loi binomiale négative semble plutôt correcte, mais un peu
moins bien que celle par la loi géométrique.

```{r, echo=FALSE, fig.width=7, fig.height=4.5}
aa <-
  rbind.data.frame(cbind.data.frame(base = "base0", cor_base0[,1:4]),
                   cbind.data.frame(base = "base2", cor_base2[,1:4]),
                   cbind.data.frame(base = "geom",  cor_gmean[,1:4]),
                   cbind.data.frame(base = "binom", cor_gpoisson[,1:4]))
levels(aa$base) <- c("Poisson", "COM-Poisson", "Géométrique", "Binomiale")

ggplot(aa, aes(x = log(estimate), y = log(real))) +
  geom_point(size = 2, shape = 1, position = "jitter") +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(~ base, scales = "free") +
  xlab("log(Estimation)") +
  ylab("log(Abondance observée)") +
  theme_bw()
```


## Vérification des estimations

### Modèles linéaires

Vérification par des modèles linéaires :

```{r models, echo=TRUE}
# estimations avec Poisson simple
modb0 <- lm(real ~ estimate,
            data = aa[aa$base == "Poisson" & !is.infinite(aa$estimate),])
summary(modb0)

# estimations avec COM Poisson
modb2 <- lm(real ~ estimate, data = aa[aa$base == "COM-Poisson",])
summary(modb2)

# estimation par moyenne géométrique de la classe
modgeo <- lm(real ~ estimate, data = aa[aa$base == "Géométrique",])
summary(modgeo)

# estimation par loi Binomiale négative
modnbino <- lm(real ~ estimate, data = aa[aa$base == "Binomiale",])
summary(modnbino)
```

### Évaluation des modèles par bootstrap

La figure suivante montre un bootstrap ($n=10000$) sur les coefficients des
modèles linéaires. La droite rouge correspond à la droite $y=x$ et les zones
colorées aux intervalles de confiance à 95 %.
L'estimation par une loi de Poisson est largement sous-estimée.
L'estimation par une loi de COM-Poisson est largement sur-estimée.
L'estimation par la moyenne géométrique ne diffère pas de la valeur observée
(recoupement de l'IC95 et de la droite $y=x$) jusqu'à une valeur d'environ 25
puis est légèrement sur-estimée pour les valeurs supérieures.

Il y a un fort recoupement des intervalles de confiance pour les estimations par
moyenne géométrique et par loi binomiale négative.
Ces deux méthodes donnent donc des résultats sensiblement identiques, la méthode
par loi binomiale négative sur-estimant légèrement plus les abondances.

```{r bootstraps, echo=FALSE, fig.width=7, fig.height=4.5}
tab_boot$estimation <- as.factor(tab_boot$estimation)
levels(tab_boot$estimation) <- c("Poisson", "COM-Poisson", "Géométrique", "Binomiale")

ggplot(tab_boot, aes(x = x, y = moy, fill = estimation)) +
  geom_line(aes(colour = estimation), size = 1.2) +
  geom_ribbon(aes(ymin = icinf, ymax = icsup), alpha = 0.2) +
  geom_abline(slope = 1, intercept = 0, col = "red", size = 1.2) +
  xlim(c(0, 50)) +
  ylim(c(0, 50)) +
  xlab("Abondance estimée") +
  ylab("Abondance observée") +
  labs(fill = "Méthode") +
  labs(colour = "Méthode") +
  theme_bw()
```

Le tableau suivant donne les valeurs de $R^2$ pour les modèles bootstrapés, avec
intervalles de confiance à 95 %.

```{r bootstraps_tab, echo=FALSE}
knitr::kable(bootsum, digits = 2)
```

Le modèle qui explique le plus les variations est celui basé sur l'estimation
par moyenne géométrique (fort $R^2$ et intervalle de confiance resserré).
L'estimation par la loi binomiale négative a un $R^2$ élevé mais un intervalle
de confiance plus large.
